name: Watcher

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  check-jira-and-change-type:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Log PR title before checks
        run: |
          PR_TITLE=$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")
          echo "â„¹ï¸ PR Title BEFORE validation: '$PR_TITLE'"

      - name: Check PR title for JIRA ticket and change type
        id: check_title
        run: |
          PR_TITLE=$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")
          echo "â„¹ï¸ Evaluating PR Title: '$PR_TITLE'"

          # Regex patterns
          JIRA_REGEX="[A-Z]+-[0-9]+"
          CHANGE_TYPE_REGEX="^(\[?[A-Z]+-[0-9]+\]? )?(feat|fix|hotfix|chore|docs|refactor|test|ci|perf|infra|style|revert|build)(\(.+\))?:"

          echo "ğŸ” Checking for valid change type..."
          if [[ ! "$PR_TITLE" =~ $CHANGE_TYPE_REGEX ]]; then
            echo "::error::âŒ Invalid PR title format. It must start with a valid change type followed by an optional scope (in parentheses)."
            echo "::error::âœ… Allowed change types: feat, fix, hotfix, chore, docs, refactor, test, ci, perf, infra, style, revert, build"
            echo "::error::ğŸ”¹ Example: 'feat(auth): Add login endpoint' or 'fix: Correct payment processing bug'."
            exit 1
          else
            DETECTED_CHANGE_TYPE=$(echo "$PR_TITLE" | grep -oE '^(feat|fix|hotfix|chore|docs|refactor|test|ci|perf|infra|style|revert|build)')
            echo "âœ… Change type detected: '$DETECTED_CHANGE_TYPE'"
          fi

          echo "ğŸ” Checking for JIRA ticket..."
          if [[ ! "$PR_TITLE" =~ $JIRA_REGEX ]]; then
            echo "::error::âŒ No JIRA ticket found in PR title. Please include a JIRA ticket number in the format ABCD-XX."
            echo "::error::ğŸ”¹ Example: 'feat(auth): Add JWT authentication [PROJ-123]'"
            exit 1
          else
            DETECTED_JIRA_TICKET=$(echo "$PR_TITLE" | grep -oE '[A-Z]+-[0-9]+')
            echo "âœ… JIRA ticket detected: '$DETECTED_JIRA_TICKET'"
          fi

          echo "âœ… PR title validation PASSED."

      - name: Post comment if checks fail
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if command -v gh &> /dev/null; then
            gh pr comment ${{ github.event.pull_request.number }} --body "ğŸš¨ **Your PR title must follow the correct format!**  
            
            **âœ… Allowed change types:**  
            \`feat\`, \`fix\`, \`hotfix\`, \`chore\`, \`docs\`, \`refactor\`, \`test\`, \`ci\`, \`perf\`, \`infra\`, \`style\`, \`revert\`, \`build\`  
            
            **ğŸ”¹ Correct Examples:**  
            - \`feat(auth): Add JWT authentication [PROJ-123]\`  
            - \`fix: Correct payment processing bug [MSEC-456]\`  
            
            Please update your PR title accordingly. ğŸ› "
          else
            echo "âš ï¸ GitHub CLI (gh) not available. Cannot post comment."
